课后作业5：本机使用G1 GC启动一个程序,仿照课上案例分析一下JVM情况

## G1 GC的基本内容
G1的全称是Garbage-First,意为垃圾优先,哪一块的垃圾最多就优先清理它。G1 GC最主要的设计目标是:将STW停顿的时间和分布,变成可预期且可配置的。事实上,G1 GC是一款软实时垃圾收集器,可以为其设置某项特定的性能指标。
为了达成可预期停顿时间的指标,G1 GC有一些独特的实现。
- 首先,堆不再分成年轻代和老年代,而是划分为多个(通常是2048个)可以存放对象的 小块堆区域(smaller heap regions)。每个小块,可能一会被定义成 Eden 区,一会被指定为 Survivor区或者Old区。
- 在逻辑上,所有的Eden区和Survivor区合起来就是年轻代,所有的Old区拼在一起那就是老年代
这样划分之后,使得 G1不必每次都去收集整个堆空间,而是以增量的方式来进行处理: 每次只处理一部分内存块,称为此次GC的回收集(collection set)。每次GC暂停都会收集所有年轻代的内存块,但一般只包含部分老年代的
内存块。
G1的另一项创新是,在并发阶段估算每个小堆块存活对象的总数。构建回收集的原则是:垃圾最多的小块会被优先收集。这也是G1名称的由来。
测试参数：-XX:+UseG1GC -XX:MaxGCPauseMillis=50

### G1 GC--配置参数
1. -XX:+UseG1GC:启用G1 GC;
2. **-XX:G1NewSizePercent**:初始年轻代占整个Java Heap的大小,默认值为5%;
3. **-XX:G1MaxNewSizePercent**:最大年轻代占整个Java Heap的大小,默认值为60%;
4. **-XX:G1HeapRegionSize**:设置每个Region的大小,单位MB,需要为1,2,4,8,16,32中的某个值,默认是堆内存的1/2000。如果这个值设置比较大,那么大对象就可以进入Region了。
5. **-XX:ConcGCThreads**:与Java应用一起执行的GC线程数量,默认是Java线程的1/4,减少这个参数的数值可能会提升并行回收的效率,提高系统内部吞吐量。如果这个数值过低,参与回收垃圾的线程不足,也会导致并行回收机制耗时加长。
6. **-XX:+InitiatingHeapOccupancyPercent(简称IHOP)**: G1内部并行回收循环启动的阈值,默认为JavaHeap的45%。这个可以理解为老年代使用大于等于45%的时候,JVM会启动垃圾回收。这个值非常重要,它决定了在什么时间启动老年代的并行回收。
7. **-XX:G1HeapWastePercent**:G1停止回收的最小内存大小,默认是堆大小的5%。GC会收集所有的Region中的对象,但是如果下降到了5%,就会停下来不再收集了。就是说,不必每次回收就把所有的垃圾都处理完,可以遗留少量的下次处理,这样也降低了单次消耗的时间。
8. -XX:G1MixedGCCountTarget:设置并行循环之后需要有多少个混合GC启动,默认值是8个。老年代Regions的回收时间通常比年轻代的收集时间要长一些。所以如果混合收集器比较多,可以允许G1延长老年代的收集时间。
9. -XX:+G1PrintRegionLivenessInfo:这个参数需要和 -XX:+UnlockDiagnosticVMOptions 配合启动,打印JVM的调试信息,每个Region里的对象存活信息。
10. -XX:G1ReservePercent:G1为了保留一些空间用于年代之间的提升,默认值是堆空间的10%。因为大量执行回收的地方在年轻代(存活时间较短),所以如果你的应用里面有比较大的堆内存空间、比较多的大对象存活,这里需要保留一些内存。
11. -XX:+G1SummarizeRSetStats:这也是一个VM的调试信息。如果启用,会在VM退出的时候打印出RSets的详细总结信息。如果启用-XX:G1SummaryRSetStatsPeriod参数,就会阶段性地打印RSets信息。
12. -XX:+G1TraceConcRefinement:这个也是一个VM的调试信息,如果启用,并行回收阶段的日志就会被详细打印出来。
13. **-XX:+GCTimeRatio**:这个参数就是计算花在Java应用线程上和花在GC线程上的时间比率,默认是9,跟新生代内存的分配比例一致。这个参数主要的目的是让用户可以控制花在应用上的时间,G1的计算公式是100/(1+GCTimeRatio)。这样如果参数设置为9,则最多10%的时间会花在GC工作上面。Parallel GC的默认值是99,表示1%的时间被用在GC上面,这是因为Parallel GC贯穿整个GC,而G1则根据Region来进行划分,不需要全局性扫描整个内存堆。
14. -XX:+UseStringDeduplication:手动开启Java String对象的去重工作,这个是JDK8u20版本之后新增的参数,主要用于相同String避免重复申请内存,节约Region的使用。
15. **-XX:MaxGCPauseMills**:预期G1每次执行GC操作的暂停时间,单位是毫秒,默认值是200毫秒,G1会尽量保证控制在这个范围内。

### G1 GC的处理步骤
1、年轻代模式转移暂停(Evacuation Pause)
G1 GC会通过前面一段时间的运行情况来不断的调整自己的回收策略和行为,以此来比较稳定地控制暂停时间。在应用程序刚启动时,G1还没有采集到什么足够的信息,这时候就处于初始的 fully-young 模式。当年轻代空间用满后,应用线程会被暂停,年轻代内存块中的存活对象被拷贝到存活区。如果还没有存活区,则任意选择一部分空闲的内存块作为存活区。拷贝的过程称为转移(Evacuation),这和前面介绍的其他年轻代收集器是一样的工作原理。

2、并发标记(Concurrent Marking)
同时我们也可以看到,G1 GC的很多概念建立在CMS的基础上,所以下面的内容需要对CMS有一定的理解。
G1并发标记的过程与CMS基本上是一样的。G1的并发标记通过 Snapshot-At-The-Beginning(起始快照) 的方式,在标记阶段开始时记下所有的存活对象。即使在标记的同时又有一些变成了垃圾。通过对象的存活信息,可以构建出每个小堆块的存活状态,以便回收集能高效地进行选择。这些信息在接下来的阶段会用来执行老年代区域的垃圾收集。
有两种情况是可以完全并发执行的:
一、如果在标记阶段确定某个小堆块中没有存活对象,只包含垃圾;
二、在STW转移暂停期间,同时包含垃圾和存活对象的老年代小堆块。
当堆内存的总体使用比例达到一定数值,就会触发并发标记。这个默认比例是 45%,但也可以通过JVM参数 InitiatingHeapOccupancyPercent 来设置。和CMS一样,G1的并发标记也是由多个阶段组成,其中一些阶段是完全并发的,还有一些阶段则会暂停应用线程。

- 阶段 1: Initial Mark(初始标记)
   - 此阶段标记所有从GC根对象直接可达的对象。
- 阶段 2: Root Region Scan(Root区扫描)
   - 此阶段标记所有从 "根区域" 可达的存活对象。根区域包括:非空的区域,以及在标记过程中不得不收集的区域。
- 阶段 3: Concurrent Mark(并发标记)
   - 此阶段和CMS的并发标记阶段非常类似:只遍历对象图,并在一个特殊的位图中标记能访问到的对象。
- 阶段 4: Remark(再次标记)
   - 和CMS类似,这是一次STW停顿(因为不是并发的阶段),以完成标记过程。 G1收集器会短暂地停止应用线程,停止并发更新信息的写入,处理其中的少量信息,并标记所有在并发标记开始时未被标记的存活对象。
- 阶段 5: Cleanup(清理)
   - 最后这个清理阶段为即将到来的转移阶段做准备,统计小堆块中所有存活的对象,并将小堆块进行排序,以提升GC的效率,维护并发标记的内部状态。 所有不包含存活对象的小堆块在此阶段都被回收了。有一部分任务是并发的:例如空堆区的回收,还有大部分的存活率计算。此阶段也需要一个短暂的STW暂停。

3、转移暂停: 混合模式(Evacuation Pause (mixed))
并发标记完成之后,G1将执行一次混合收集(mixed collection),就是不只清理年轻代,还将一部分老年代区域也加入到 回收集 中。混合模式的转移暂停不一定紧跟并发标记阶段。有很多规则和历史数据会影响混合模式的启动时机。比如,假若在老年代中可以并发地腾出很多的小堆块,就没有必要启动混合模式。
因此,在并发标记与混合转移暂停之间,很可能会存在多次 young 模式的转移暂停。具体添加到回收集的老年代小堆块的大小及顺序,也是基于许多规则来判定的。其中包括指定的软实时性能指标,存活性,以及在并发标记期间收集的GC效率等数据,外加一些可配置的JVM选项。混合收集的过程,很大程度上和前面的fully-young gc是一样的。

### G1 GC的注意事项
特别需要注意的是,某些情况下G1触发了Full GC,这时G1会退化使用Serial收集器来完成垃圾的清理工作,它仅仅使用单线程来完成GC工作,GC暂停时间将达到秒级别的。
1. 并发模式失败
   - G1启动标记周期,但在Mix GC之前,老年代就被填满,这时候G1会放弃标记周期。解决办法:增加堆大小,或者调整周期(例如增加线程数-XX:ConcGCThreads等)。
2. 晋升失败
   - 没有足够的内存供存活对象或晋升对象使用,由此触发了Full GC(to-space exhausted/to-space overflow)。解决办法:
   - a)增加 -XX:G1ReservePercent 选项的值(并相应增加总的堆大小)增加预留内存量。
   - b)通过减少 -XX:InitiatingHeapOccupancyPercent 提前启动标记周期。
   - c)也可以通过增加 -XX:ConcGCThreads 选项的值来增加并行标记线程的数目。
3. 巨型对象分配失败
   - 当巨型对象找不到合适的空间进行分配时,就会启动Full GC,来释放空间。解决办法:增加内存或者增大-XX:G1HeapRegionSize

### 实例分析

### 业务系统的JVM参数
-XX:+HeapDumpOnOutOfMemoryError -XX:+PrintGCDetails -Xms256m -Xmx256m -XX:+UseG1GC


### 使用jmap分析
```
$ sudo jmap -heap 28677
Attaching to process ID 28677, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 24.65-b04

using thread-local object allocation.
Garbage-First (G1) GC with 2 thread(s)

Heap Configuration:
   MinHeapFreeRatio = 40                             // heap在使用率小于40的情况下, heap进行收缩, Xmx==Xms的情况下无效 
   MaxHeapFreeRatio = 70                             // heap在使用率大于70的情况下, heap进行扩张, Xmx==Xms的情况下无效
   MaxHeapSize      = 268435456 (256.0MB)            // 堆的最大值
   NewSize          = 1363144 (1.2999954223632812MB) // 初始年轻代占整个Java Heap的大小,默认值为5%
   MaxNewSize       = 17592186044415 MB              // 最大年轻代占整个Java Heap的大小,默认值为60%
   OldSize          = 5452592 (5.1999969482421875MB) // 初始老年代占整个Java Heap的大小 
   NewRatio         = 2                              // 老年代 与 年轻代 的比例
   SurvivorRatio    = 8                              // 年轻代中Eden Space与一个Survivor的比例 8:1:1
   PermSize         = 20971520 (20.0MB)              // 初始永久代占整个Java Heap的大小
   MaxPermSize      = 174063616 (166.0MB)            // 最大年轻代占整个Java Heap的大小
   G1HeapRegionSize = 1048576 (1.0MB)                // 设置每个Region的大小,单位MB,默认是堆内存的1/2000

Heap Usage:
G1 Heap:
   regions  = 256                                     // 区域数256
   capacity = 268435456 (256.0MB)
   used     = 225719784 (215.2631607055664MB)
   free     = 42715672 (40.736839294433594MB)
   84.08717215061188% used
G1 Young Generation:
Eden Space:                                           // 区域数129
   regions  = 129
   capacity = 155189248 (148.0MB)
   used     = 135266304 (129.0MB)
   free     = 19922944 (19.0MB)
   87.16216216216216% used
Survivor Space:
   regions  = 6                                       // 区域数6
   capacity = 6291456 (6.0MB)
   used     = 6291456 (6.0MB)
   free     = 0 (0.0MB)
   100.0% used
G1 Old Generation:
   regions  = 88                                      // 区域数88
   capacity = 106954752 (102.0MB)
   used     = 83113448 (79.2631607055664MB)
   free     = 23841304 (22.736839294433594MB)
   77.70898108388863% used
Perm Generation:
   capacity = 51380224 (49.0MB)
   used     = 50343920 (48.01170349121094MB)
   free     = 1036304 (0.9882965087890625MB)
   97.98306834941008% used

20433 interned Strings occupying 2132200 bytes.
```

#### 发现一个奇怪的值
MaxNewSize       = 17592186044415 MB 
```C++
// C++代码
product(uintx, MaxNewSize, max_uintx,                                  \  
        "Maximum new generation size (in bytes), max_uintx means set " \  
        "ergonomically")     
```

在HotSpot VM里，intx是跟平台字长一样宽的带符号整型，uintx是其无符号版。max_uintx是(uintx) -1，也就是说在32位平台上是无符号的0xFFFFFFFF，64位平台上则是0xFFFFFFFFFFFFFFFF。
jmap -heap显示的部分参数是以MB为单位来显示的，而MaxNewSize的单位是byte。我跑例子的平台是64位的，于是算一下 0xFFFFFFFFFFFFFFFF / 1024 / 1024 = 17592186044415 MB 。
参数的说明告诉我们，当MaxNewSize的值等于max_uintx时，意思就是交由ergonomics来自动选择young gen的最大大小。并不是说younggen的最大大小真的有0xFFFFFFFFFFFFFFFF这么大。



### 使用jstat分析

#### GC情况
```
$ $ jstat -gc 28677 1000 1000
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT   
...
 0.0   6144.0  0.0   6144.0 158720.0 147456.0  97280.0    63981.5   48128.0 47642.3     11    0.360   0      0.000    0.360
 0.0   6144.0  0.0   6144.0 158720.0 149504.0  97280.0    63981.5   48128.0 47647.9     11    0.360   0      0.000    0.360
 0.0   14336.0  0.0   14336.0 147456.0  6144.0   100352.0   63981.5   48128.0 47653.4     12    0.437   0      0.000    0.437
 0.0   14336.0  0.0   14336.0 147456.0  6144.0   100352.0   63981.5   48128.0 47653.4     12    0.437   0      0.000    0.437
...
 0.0   14336.0  0.0   14336.0 147456.0 138240.0  100352.0   63981.5   48128.0 47787.3     12    0.437   0      0.000    0.437
 0.0   14336.0  0.0   14336.0 147456.0 138240.0  100352.0   63981.5   48128.0 47787.3     12    0.437   0      0.000    0.437
 0.0   14336.0  0.0   14336.0 147456.0 139264.0  100352.0   63981.5   48128.0 47787.3     13    0.437   0      0.000    0.437
 0.0   10240.0  0.0   10240.0 154624.0 10240.0   97280.0    63981.5   48128.0 47793.2     13    0.475   0      0.000    0.475
...
 0.0   10240.0  0.0   10240.0 154624.0 134144.0  97280.0    63981.5   48128.0 47849.9     13    0.475   0      0.000    0.475
 0.0   10240.0  0.0   10240.0 154624.0 142336.0  97280.0    63981.5   48128.0 47850.9     13    0.475   0      0.000    0.475
 0.0   10240.0  0.0   10240.0 154624.0  3072.0   97280.0    63981.5   48128.0 47852.3     14    0.516   0      0.000    0.516
 0.0   10240.0  0.0   10240.0 154624.0  3072.0   97280.0    63981.5   48128.0 47852.3     14    0.516   0      0.000    0.516
...
 0.0   10240.0  0.0   10240.0 154624.0 138240.0  97280.0    63981.5   48128.0 47885.6     14    0.516   0      0.000    0.516
 0.0   10240.0  0.0   10240.0 154624.0 140288.0  97280.0    63981.5   48128.0 47885.6     14    0.516   0      0.000    0.516
 0.0   10240.0  0.0   10240.0 154624.0 10240.0   97280.0    63981.5   48128.0 47896.0     15    0.554   0      0.000    0.554
 0.0   10240.0  0.0   10240.0 154624.0 10240.0   97280.0    63981.5   48128.0 47896.0     15    0.554   0      0.000    0.554
...
 0.0   10240.0  0.0   10240.0 154624.0 119808.0  97280.0    63981.5   48128.0 47983.5     15    0.554   0      0.000    0.554
 0.0   10240.0  0.0   10240.0 154624.0 138240.0  97280.0    63981.5   48128.0 47989.3     15    0.554   0      0.000    0.554
 0.0   10240.0  0.0   10240.0 154624.0   0.0     97280.0    63469.5   48128.0 47996.7     16    0.588   0      0.000    0.588
 0.0   10240.0  0.0   10240.0 154624.0 10240.0   97280.0    63469.5   48128.0 48000.6     16    0.588   0      0.000    0.588
...
 0.0   10240.0  0.0   10240.0 154624.0 143360.0  97280.0    63469.5   48128.0 48122.5     18    0.814   0      0.000    0.814
 0.0   10240.0  0.0   10240.0 154624.0 145408.0  97280.0    63469.5   48128.0 48122.5     18    0.814   0      0.000    0.814
 0.0   9216.0  0.0   9216.0 155648.0  6144.0   97280.0    63981.5   48128.0 48122.8     19    0.851   0      0.000    0.851
 0.0   9216.0  0.0   9216.0 155648.0  6144.0   97280.0    63981.5   48128.0 48122.8     19    0.851   0      0.000    0.851
...
 0.0   10240.0  0.0   10240.0 154624.0 97280.0   97280.0    63981.5   49152.0 48533.0     24    1.272   0      0.000    1.272
 0.0   10240.0  0.0   10240.0 154624.0 123904.0  97280.0    63981.5   49152.0 48535.7     24    1.272   0      0.000    1.272
 0.0   6144.0  0.0   6144.0 158720.0 10240.0   97280.0    67831.0   49152.0 48535.7     25    1.306   0      0.000    1.306
 0.0   6144.0  0.0   6144.0 158720.0 35840.0   97280.0    67831.0   49152.0 48535.9     25    1.306   0      0.000    1.306
...
 0.0   6144.0  0.0   6144.0 158720.0 130048.0  97280.0    69101.5   49152.0 48556.5     26    1.337   0      0.000    1.337
 0.0   6144.0  0.0   6144.0 158720.0 147456.0  97280.0    69101.5   49152.0 48557.0     26    1.337   0      0.000    1.337
 0.0   3072.0  0.0   3072.0 160768.0 13312.0   98304.0    72670.9   49152.0 48558.2     27    1.362   0      0.000    1.362
 0.0   3072.0  0.0   3072.0 160768.0 29696.0   98304.0    72670.9   49152.0 48559.2     27    1.362   0      0.000    1.362
...
 0.0   3072.0  0.0   3072.0 158720.0 147456.0  100352.0   74420.9   49152.0 48656.9     31    1.457   0      0.000    1.457
 0.0   3072.0  0.0   3072.0 158720.0 148480.0  100352.0   74420.9   49152.0 48656.9     31    1.457   0      0.000    1.457
 0.0   2048.0  0.0   2048.0 160768.0 22528.0   99328.0    75050.2   49152.0 48659.0     32    1.476   0      0.000    1.476
 0.0   2048.0  0.0   2048.0 160768.0 26624.0   99328.0    75050.2   49152.0 48659.8     32    1.476   0      0.000    1.476
...
 0.0   3072.0  0.0   3072.0 158720.0 139264.0  100352.0   75094.9   49152.0 48703.8     34    1.522   0      0.000    1.522
 0.0   3072.0  0.0   3072.0 158720.0 147456.0  100352.0   75094.9   49152.0 48704.1     34    1.522   0      0.000    1.522
 0.0   4096.0  0.0   4096.0 156672.0 13312.0   101376.0   74518.9   49152.0 48704.3     35    1.553   0      0.000    1.553
 0.0   4096.0  0.0   4096.0 156672.0 24576.0   101376.0   74518.9   49152.0 48707.0     35    1.553   0      0.000    1.553
...
 0.0   3072.0  0.0   3072.0 157696.0 130048.0  101376.0   76058.0   49152.0 49151.4     54    2.324   0      0.000    2.324
 0.0   3072.0  0.0   3072.0 157696.0 148480.0  101376.0   76058.0   49152.0 49151.4     54    2.324   0      0.000    2.324
 0.0   6144.0  0.0   6144.0 151552.0 10240.0   104448.0   77846.7   49152.0 49151.4     55    2.359   0      0.000    2.359
 0.0   6144.0  0.0   6144.0 151552.0 10240.0   104448.0   77846.7   49152.0 49151.4     55    2.359   0      0.000    2.359
 0.0   6144.0  0.0   6144.0 151552.0 10240.0   104448.0   77846.7   49152.0 49151.4     55    2.359   0      0.000    2.359
 0.0   6144.0  0.0   6144.0 151552.0 10240.0   104448.0   77846.7   49152.0 49151.4     55    2.359   0      0.000    2.359
 0.0   6144.0  0.0   6144.0 151552.0 17408.0   104448.0   77846.7   49152.0 49151.4     55    2.359   0      0.000    2.359
 0.0   6144.0  0.0   6144.0 151552.0 17408.0   104448.0   77846.7   49152.0 49151.4     55    2.359   0      0.000    2.359
 0.0   6144.0  0.0   6144.0 151552.0 17408.0   104448.0   77846.7   49152.0 49151.4     55    2.359   0      0.000    2.359
 0.0   6144.0  0.0   6144.0 151552.0 18432.0   104448.0   77846.7   49152.0 49151.4     55    2.359   0      0.000    2.359
 0.0   6144.0  0.0   6144.0 151552.0 30720.0   104448.0   77846.7   50176.0 49152.0     55    2.359   0      0.000    2.359
 0.0   6144.0  0.0   6144.0 151552.0 30720.0   104448.0   77846.7   50176.0 49152.0     55    2.359   0      0.000    2.359

```
